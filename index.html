<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- CSP copiado de cuaderno-profesor para permitir Google APIs -->
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://polyfill.io https://apis.google.com https://accounts.google.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https://www.google.com https://*.googleusercontent.com; font-src 'self' data:; connect-src 'self' https://www.googleapis.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://accounts.google.com https://apis.google.com; frame-src 'self' https://accounts.google.com https://content.googleapis.com https://docs.google.com;">
    <title>Panel de Control v18.0 (Firebase Edition)</title>
    <style>
        :root {
            --theme-color-windows: #0d6efd;
            --theme-color-kubuntu: #198754;
            --current-theme-color: var(--theme-color-kubuntu);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            background-color: #f8f9fa;
            color: #212529;
        }

        .sticky-top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: var(--current-theme-color);
            color: white;
            transition: background-color 0.3s;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .sticky-top-bar h1 {
            color: white;
            border: none;
            margin: 0;
            font-size: 1.5em;
        }

        .selectors-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .selectors-container label {
            margin: 0;
            font-weight: normal;
            color: white;
        }

        .selectors-container select {
            margin-top: 0;
            width: 220px;
        }

        .container {
            max-width: 900px;
            margin: 20px auto;
        }

        .workflow-box,
        .setup-box {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        h2,
        h3,
        h4 {
            color: var(--current-theme-color);
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
            transition: color 0.3s;
        }

        label {
            font-weight: bold;
            display: block;
            margin-top: 15px;
        }

        input[type="text"],
        select {
            width: 95%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }

        input[readonly] {
            background-color: #e9ecef;
            cursor: not-allowed;
        }

        .command-box {
            background-color: #e9ecef;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
            font-family: "Courier New", monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            position: relative;
        }

        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            background-color: #555;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .copy-btn:hover {
            background-color: #333;
        }

        .action-btn {
            display: inline-block;
            padding: 10px 15px;
            margin-top: 10px;
            font-size: 1em;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-right: 10px;
        }

        .action-btn.save {
            background-color: var(--current-theme-color);
        }

        .action-btn.clone {
            background-color: #0dcaf0;
            color: #000;
        }

        .action-btn.edit {
            background-color: #ffc107;
            color: #000;
        }

        .action-btn.danger {
            background-color: #dc3545;
        }

        .action-btn:hover {
            opacity: 0.8;
        }

        #taskForm {
            border-top: 2px solid #e9ecef;
            margin-top: 20px;
            padding-top: 15px;
        }

        p,
        li {
            color: #6c757d;
            line-height: 1.6;
        }

        details {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            background-color: #fff;
        }

        summary {
            font-weight: bold;
            font-size: 1.2em;
            cursor: pointer;
            color: var(--current-theme-color);
            transition: color 0.3s;
        }

        code {
            color: #d63384;
        }

        .placeholder-ip,
        .placeholder-date,
        .placeholder-key {
            color: #d63384;
            font-weight: bold;
        }

        .explanation {
            background-color: #f8f9fa;
            border-left: 4px solid var(--current-theme-color);
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            transition: border-left-color 0.3s;
        }

        .warning {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
        }

        .danger {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
        }

        optgroup {
            font-weight: bold;
            font-style: italic;
            background-color: #f8f9fa;
        }

        .move-direction {
            margin-top: 15px;
        }

        .move-direction label {
            display: inline;
            margin-right: 20px;
            font-weight: normal;
        }
    </style>
</head>

<body>

    <div class="sticky-top-bar">
        <h1 id="main-title">üöÄ Panel de Control</h1>
        <div class="selectors-container">
            <div id="auth-container" style="margin-right: 15px;">
                <button id="authBtn" onclick="handleAuthClick()"
                    style="display: none; background-color: white; color: #333; border: 1px solid #ccc; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; align-items: center;">
                    <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA0OCA0OCI+PGRlZnM+PHN0eWxlPi5he2ZpbGw6bm9uZTt9PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTQ0LjUsMjBIMjR2OC41aDExLjhDMzQuNywzMy45LDMwLjEsMzcsMjQsMzdjLTcuMiwwLTEzLTUuOC0xMy0xM3M1LjgtMTMsMTMtMTNjMy4xLDAsNS45LDEuMSw4LjEsMi45bDYuNC02LjRDMzQuNiw0LjEsMjkuNiwyLDI0LDJDMTEuOCwyLDIsMTEuOCwyLDI0czkuOCwyMiwyMiwyMnMxNy05LjIsMjItMjJDNjYsMjIuNiw0NC41LDIwLDQ0LjUsMjB6IiBmaWxsPSIjNDI4NUY0Ii8+PHBhdGggZD0iTTQzLjMsMzEuNEM0Ny4zLDI2LjgsNDgsMjEuNiw0Ni41LDE2LjVjLTAuNC0xLjItMS0yLjMtMS44LTMuM2wtNi40LDYuNGMxLjEsMS4xLDEuNywyLjYsMSu3LDQuMmMwLDEuNS0wLjUsMi45LTEuMyw0LjFMMzguNywzMi45QzQwLjQsMzIuNiw0MS45LDMyLjEsNDMuMywzMS40eiIgZmlsbD0iIzNCQzhEQiIvPjxwYXRoIGQ9Ik00My4zLDMxLjRMMzguNywzMi45YzEuNSwzLDAsNi42LTMuMyw4bC01LjgsNC4zQzM2LjMsNDMuOCw0MC45LDM4LjYsNDMuMywzMS40eiIgZmlsbD0iIzM0QTg1MyIvPjxwYXRoIGQ9Ik00My4zLDMxLjRMMzguNywzMi45Yy0wLjMsMC42LTAuNywxLjItMS4yLDEuN2w1LjgsNC4zQzQ0LjYsMzcuMyw0NS4yLDM0LjUsNDMuMywzMS40eiIgZmlsbD0iIzQyODVGNCIvPjxwYXRoIGQ9Ik0yNCw0NmM1LjMsMCwxMC4yLTEuOCwxNC4xLTQuOWwtNS44LTQuM2MtMi4zLDEuNi01LjEsMi4yLTcuOSwxLjJjLTIuOC0xLTUuMS0zLjMtNi02LjFsLTUuNyw0LjRDMTcuNCw0Mi40LDIwLjUsNDYsMjQsNDZ6IiBmaWxsPSIjMzRBODUzIi8+PHBhdGggZD0iTTI0LDQ2Yy01LjksMC0xMS4yLTMtMTQuMy03LjlsNS43LTQuNGMxLjMsMy43LDQuOSw2LjMsOS4xLDYuM2MwLjYsMCwxLjItMC4xLDEuOC0wLjJMMjQsNDZ6IiBmaWxsPSIjMzRBODUzIi8+PHBhdGggZD0iTTguNCwzMy43QzYuNiwzMC45LDUuOCwyNy41LDYsMjRjMC0zLjUsMC44LTYuOSwyLjYtOS42bC01LjctNC40QzAuOSwxMy4yLDAsMTguNSwwLDI0YzAsNS41LDAuOSwxMC44LDIuOSwxNC4xTDguNCwzMy43eiIgZmlsbD0iI0ZCQkMwNSIvPjxwYXRoIGQ9Ik0yNCwyYy01LjksMC0xMS4yLDMtMTQuMyw3LjlsNS43LDQuNGMxLjMsMy43LDQuOSw2LjMsOS4xLTYuM2MyLjYsMCw1LDEsNi45LDIuOGw2LjQtNi40QzM0LjIsMS44LDI5LjMsMCwyNCwweiIgZmlsbD0iI0VBNDMzNSIvPjwvc3ZnPg=="
                        alt="G" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;">
                    Conectar Drive
                </button>
                <button id="signoutBtn" onclick="handleSignoutClick()"
                    style="display: none; background-color: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                    Desconectar
                </button>
                <span id="authStatus" style="font-size: 0.8em; margin-left: 5px;"></span>
            </div>

            <div style="margin-right: 15px; display: flex; gap: 8px;">
                <button id="copyConfigBtn" onclick="copyConfigToClipboard()"
                    style="background-color: #6f42c1; color: white; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9em; font-weight: bold;"
                    title="Copiar JSON al portapapeles">
                    üìã Copiar JSON
                </button>
                <button id="downloadConfigBtn" onclick="downloadConfigAsJSON()"
                    style="background-color: #198754; color: white; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9em; font-weight: bold;"
                    title="Descargar configuraci√≥n como JSON">
                    üì• Descargar JSON
                </button>
                <button id="uploadConfigBtn" onclick="document.getElementById('uploadConfigInput').click()"
                    style="background-color: #0dcaf0; color: white; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9em; font-weight: bold;"
                    title="Cargar configuraci√≥n desde archivo JSON">
                    üì§ Cargar JSON
                </button>
                <button id="driveLoadBtn" onclick="connectAndLoadFromDrive()"
                    style="background-color: #fd7e14; color: white; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9em; font-weight: bold;"
                    title="Conectar a Google Drive y cargar configuraci√≥n">
                    üîó Cargar desde Drive
                </button>
                <input type="file" id="uploadConfigInput" accept=".json,application/json,text/*,*/*"
                    style="display: none;" onchange="loadConfigFromFile(event)">
                <span id="driveStatus" style="font-size: 0.8em; margin-left: 10px; color: #6c757d;"></span>
            </div>

            <label for="osSelector">SO:</label>
            <select id="osSelector" onchange="updateAll()">
                <option value="kubuntu">Kubuntu (Linux)</option>
                <option value="windows">Windows</option>
            </select>

            <label for="syncSelector">Tarea:</label>
            <select id="syncSelector" onchange="updateAll()"></select>
        </div>
    </div>



    <div class="container">

        <div class="workflow-box">
            <h2>PASO 1: Sincronizaci√≥n Principal de Archivos</h2>
            <p class="explanation">Usa <strong>SUBIR</strong> para guardar tus cambios en la nube y
                <strong>BAJAR</strong> para actualizar tu m√°quina local desde la nube.
            </p>
            <label for="localPath">Ruta Local (en esta m√°quina):</label>
            <input type="text" id="localPath" oninput="updateCommands()">
            <label for="remotePath">Ruta Remota (en la nube):</label>
            <input type="text" id="remotePath" oninput="updateCommands()">

            <div class="grid-container">
                <div>
                    <h3>‚ñ∂Ô∏è SUBIR a la Nube</h3>
                    <div class="command-box"><code id="syncUpCommand"></code><button class="copy-btn"
                            onclick="copyCommand('syncUpCommand')">Copiar</button></div>
                </div>
                <div>
                    <h3>‚óÄÔ∏è BAJAR desde la Nube</h3>
                    <div class="command-box"><code id="syncDownCommand"></code><button class="copy-btn"
                            onclick="copyCommand('syncDownCommand')">Copiar</button></div>
                </div>
            </div>
        </div>

        <div class="setup-box">
            <details>
                <summary>PASO 2: Administrar Tareas de Sincronizaci√≥n</summary>
                <p>Aqu√≠ puedes a√±adir, clonar, editar o eliminar tareas para la sincronizaci√≥n de archivos del PASO 1.
                </p>
                <button id="showNewTaskFormBtn" class="action-btn save">‚ûï A√±adir Nueva</button>
                <button id="cloneTaskBtn" class="action-btn clone">‚ûï Crear Tarea Basada en...</button>
                <button id="editTaskBtn" class="action-btn edit">‚úèÔ∏è Editar Tarea</button>
                <button id="deleteTaskBtn" class="action-btn danger">üóëÔ∏è Borrar Tarea</button>

                <form id="taskForm" style="display:none;">
                    <h3 id="formTitle">Definir Nueva Tarea</h3>
                    <label for="taskName">Nombre para el men√∫ (Ej: Mis Documentos)</label>
                    <input type="text" id="taskName" placeholder="Un nombre descriptivo y corto">

                    <label for="taskKey">ID √∫nico (Ej: mis_documentos)</label>
                    <input type="text" id="taskKey" placeholder="En min√∫sculas, sin espacios ni caracteres raros">

                    <label for="taskGroup">Grupo (Ej: PERSONAL)</label>
                    <input type="text" id="taskGroup" placeholder="Opcional. Para agrupar en el men√∫.">

                    <label for="taskRemote">Ruta Remota (Ej: B2:mi-nube/documentos)</label>
                    <input type="text" id="taskRemote" placeholder="Ruta completa en la nube">

                    <label for="taskLocalWin">Ruta Local en Windows</label>
                    <input type="text" id="taskLocalWin" placeholder="Ej: %USERPROFILE%\\Documents">

                    <label for="taskLocalKubuntu">Ruta Local en Kubuntu/Linux</label>
                    <input type="text" id="taskLocalKubuntu" placeholder="Ej: $HOME/Documents">

                    <button type="button" id="saveTaskBtn" class="action-btn save">üíæ Guardar Tarea</button>
                    <button type="button" id="cancelTaskBtn" class="action-btn danger">Cancelar</button>
                </form>
            </details>
        </div>

        <div class="setup-box">
            <details>
                <summary>PASO 3: Gu√≠a de Instalaci√≥n y Credenciales</summary>
                <h3>Credenciales de Backblaze B2</h3>
                <label for="keyID">keyID:</label>
                <input type="text" id="keyID" oninput="updateAll()">
                <label for="applicationKey">applicationKey:</label>
                <input type="text" id="applicationKey" oninput="updateAll()">
                <button class="action-btn save" id="savePrefsBtn">üíæ Guardar Preferencias</button>
                <hr style="margin-top: 30px;">

                <h3>Gu√≠a de Instalaci√≥n de Rclone</h3>
                <div id="installWindows" style="display:none;">
                    <h4><strong>En Windows:</strong></h4>
                    <p>Descarga el <a href="https://rclone.org/downloads/" target="_blank">.zip de rclone</a>,
                        descompr√≠melo y mueve <code>rclone.exe</code> a <code>C:\rclone</code>.</p>
                </div>
                <div id="installKubuntu">
                    <h4><strong>En Kubuntu/Linux:</strong></h4>
                    <p>Abre la Terminal y ejecuta: <code class="command-box"
                            style="display: block; padding: 10px;">sudo -v ; curl https://rclone.org/install.sh | sudo bash</code>
                    </p>
                </div>
                <h4><strong>Configurar Conexi√≥n a Backblaze (un solo paso por m√°quina):</strong></h4>
                <p>Abre una consola (cmd/Terminal) y ejecuta <code id="configCommand"></code>. Sigue el asistente con
                    estas respuestas:</p>
                <ul>
                    <li><b>New remote:</b> n</li>
                    <li><b>name:</b> B2</li>
                    <li><b>Storage:</b> El n√∫mero de "Backblaze B2".</li>
                    <li><b>account:</b> <code id="keyIdDisplay"></code></li>
                    <li><b>key:</b> <code id="appKeyDisplay"></code></li>
                    <li><b>Resto de opciones:</b> Pulsa Enter en cada una.</li>
                    <li><b>Keep remote?:</b> y</li>
                    <li><b>Quit:</b> q</li>
                </ul>
            </details>
        </div>

        <div class="setup-box">
            <details>
                <summary>PASO 4: Herramientas de Verificaci√≥n y Mantenimiento</summary>
                <h3>‚ùì Comprobar si la nube ya est√° configurada</h3>
                <div class="command-box"><code id="listRemotesCommand"></code><button class="copy-btn"
                        onclick="copyCommand('listRemotesCommand')">Copiar</button></div>
                <h3>‚úÖ Comprobar Diferencias (Modo Seguro)</h3>
                <p>Compara la carpeta local con la nube, pero <strong>no modifica nada</strong>.</p>
                <div class="command-box"><code id="checkCommand"></code><button class="copy-btn"
                        onclick="copyCommand('checkCommand')">Copiar</button></div>
                <h3>üí° Modo de Prueba (Dry Run)</h3>
                <p>Simula una sincronizaci√≥n de SUBIDA sin tocar nada.</p>
                <div class="command-box"><code id="dryRunCommand"></code><button class="copy-btn"
                        onclick="copyCommand('dryRunCommand')">Copiar</button></div>
                <h3>üìä Calcular Tama√±o en la Nube</h3>
                <div class="command-box"><code id="sizeCommand"></code><button class="copy-btn"
                        onclick="copyCommand('sizeCommand')">Copiar</button></div>

                <hr style="margin-top: 30px; border-top: 1px solid #dee2e6;">
                <h3 style="color: #c88f02; border-color: #c88f02;">‚û°Ô∏è Mover Carpetas (Cortar y Pegar)</h3>
                <div class="warning">
                    <p><strong>Atenci√≥n:</strong> Esta operaci√≥n mueve los archivos del origen al destino y despu√©s los
                        <strong>BORRA del origen</strong>. √ösalo para archivar o reorganizar.
                    </p>
                </div>

                <label for="moveSourceTask">1. Origen (Carpeta que quieres "Cortar"):</label>
                <select id="moveSourceTask" onchange="updateMoveCommand()"></select>

                <div class="move-direction">
                    <label><input type="radio" name="moveDirection" value="localToRemote" onchange="updateMoveCommand()"
                            checked> Mover de PC ‚û°Ô∏è a Nube</label>
                    <label><input type="radio" name="moveDirection" value="remoteToLocal"
                            onchange="updateMoveCommand()"> Mover de Nube ‚û°Ô∏è a PC</label>
                </div>

                <label for="moveDestinationPath">2. Destino (Ubicaci√≥n donde quieres "Pegar"):</label>
                <input type="text" id="moveDestinationPath" placeholder="Ej: B2:xtrategyq-datos/trading/archive/2025"
                    oninput="updateMoveCommand()">

                <label>3. Comando a Ejecutar:</label>
                <div class="command-box">
                    <code id="moveCommandPreview">Selecciona origen, destino y direcci√≥n para ver el comando.</code>
                    <button id="executeMoveBtn" class="copy-btn" style="background-color: #c88f02;"
                        onclick="executeMove()">Copiar Movimiento</button>
                </div>

                <hr style="margin-top: 30px; border-top: 1px solid #dee2e6;">
                <h3 style="color: #dc3545;">üö® Mantenimiento Avanzado (¬°Peligro!)</h3>
                <h3>üóëÔ∏è Borrar un archivo o carpeta espec√≠fica en la nube</h3>
                <label for="deletePath">Ruta a borrar (relativa a la Ruta Remota de la tarea actual):</label>
                <input type="text" id="deletePath" placeholder="Ej: subcarpeta_a_borrar/archivo.txt"
                    oninput="updateCommands()">
                <div class="command-box"><code id="deleteSpecificCommand"></code><button class="copy-btn"
                        onclick="copyDangerousCommand('deleteSpecificCommand', '¬øEst√°s seguro de que quieres borrar este elemento espec√≠fico de la nube? Esta acci√≥n no se puede deshacer.')">Copiar</button>
                </div>
                <h3>üí• Purgar (borrar TODO) el contenido de la ruta remota</h3>
                <p class="danger"><strong>¬°ADVERTENCIA M√ÅXIMA!</strong> Este comando borrar√° <strong>TODO</strong>
                    dentro de la Ruta Remota seleccionada actualmente.</p>
                <div class="command-box"><code id="purgeCommand"></code><button class="copy-btn"
                        onclick="copyDangerousCommand('purgeCommand', '¬°ADVERTENCIA! Vas a borrar TODO el contenido de la carpeta seleccionada en la nube. ¬øEst√°s absolutamente seguro?')">Copiar</button>
                </div>
            </details>
        </div>

        <div class="setup-box" id="cacheFixSection" style="border: 2px solid #dc3545;">
            <details>
                <summary style="color: #dc3545;">PASO 5: Soluci√≥n de Errores de Compilaci√≥n en SQX</summary>
                <div class="explanation">
                    <p><strong>S√≠ntoma:</strong> Al iniciar StrategyQuant X, recibes errores como
                        <code>Note - Compile all failed</code> o <code>cannot find symbol</code>.
                    </p>
                    <p><strong>Causa:</strong> La cach√© de compilaci√≥n local de SQX est√° corrupta.</p>
                </div>
                <h3>Pasos para la Soluci√≥n</h3>
                <ol>
                    <li><strong>CERRAR STRATEGYQUANT X POR COMPLETO.</strong></li>
                    <li><strong>ELIMINAR CARPETAS DE CACH√â LOCALES:</strong> Ejecuta los comandos correspondientes.</li>
                </ol>
                <div id="cacheCommandsWindows" style="display:none;">
                    <p>Comandos para <strong>Windows</strong> (<code>cmd</code> como Administrador):</p>
                    <div class="command-box"><code id="deleteCacheCmdWin1"></code><button class="copy-btn"
                            onclick="copyCommand('deleteCacheCmdWin1')">Copiar</button></div>
                    <div class="command-box"><code id="deleteCacheCmdWin2"></code><button class="copy-btn"
                            onclick="copyCommand('deleteCacheCmdWin2')">Copiar</button></div>
                    <div class="command-box"><code id="deleteCacheCmdWin3"></code><button class="copy-btn"
                            onclick="copyCommand('deleteCacheCmdWin3')">Copiar</button></div>
                    <div class="command-box"><code id="deleteCacheCmdWin4"></code><button class="copy-btn"
                            onclick="copyCommand('deleteCacheCmdWin4')">Copiar</button></div>
                </div>
                <div id="cacheCommandsKubuntu">
                    <p class="danger"><strong>¬°Atenci√≥n!</strong> <code>rm -rf</code> borra de forma permanente.</p>
                    <p>Comandos para <strong>Kubuntu</strong>:</p>
                    <div class="command-box"><code id="deleteCacheCmdKubuntu1"></code><button class="copy-btn"
                            onclick="copyCommand('deleteCacheCmdKubuntu1')">Copiar</button></div>
                    <div class="command-box"><code id="deleteCacheCmdKubuntu2"></code><button class="copy-btn"
                            onclick="copyCommand('deleteCacheCmdKubuntu2')">Copiar</button></div>
                    <div class="command-box"><code id="deleteCacheCmdKubuntu3"></code><button class="copy-btn"
                            onclick="copyCommand('deleteCacheCmdKubuntu3')">Copiar</button></div>
                    <div class="command-box"><code id="deleteCacheCmdKubuntu4"></code><button class="copy-btn"
                            onclick="copyCommand('deleteCacheCmdKubuntu4')">Copiar</button></div>
                </div>
                <ol start="3">
                    <li><strong>RESINCRONIZAR DESDE LA NUBE:</strong> Vuelve al PASO 1 y ejecuta <strong>BAJAR</strong>.
                    </li>
                    <li><strong>REINICIAR STRATEGYQUANT X.</strong></li>
                </ol>
            </details>
        </div>

        <div class="setup-box" style="border: 2px solid #20c997;">
            <details>
                <summary style="color: #20c997;">PASO 6: Creaci√≥n del Backup Fiable (Fase 1)</summary>
                <div class="explanation" style="border-left-color: #20c997;">
                    <p>Esta fase se ejecuta en tu <strong>servidor de producci√≥n</strong> para crear un backup
                        actualizado y portable. Este backup contiene tus datos, configuraciones y la lista de software,
                        permitiendo una restauraci√≥n fiable en cualquier hardware.</p>
                </div>

                <h4>1.1. Definir la Fecha del Backup</h4>
                <p>Para asegurar que todos los archivos tengan la misma versi√≥n, primero definimos una variable con la
                    fecha actual.</p>
                <div class="command-box"><code id="f1_fecha">FECHA=$(date +%Y-%m-%d)
echo "La fecha para los archivos de hoy es: $FECHA"</code><button class="copy-btn"
                        onclick="copyCommand('f1_fecha')">Copiar</button></div>

                <h4>1.2. Crear el Backup Esencial (.tar.gz)</h4>
                <p>Este comando usa la variable <code>$FECHA</code> para empaquetar tus datos (<code>/home</code>) y
                    configuraciones (<code>/etc</code>).</p>
                <div class="command-box"><code
                        id="f1_tar">sudo tar -cvpzf /root/mi_backup_esencial-$FECHA.tar.gz /home/ /etc/</code><button
                        class="copy-btn" onclick="copyCommand('f1_tar')">Copiar</button></div>

                <h4>1.3. Crear la Lista de Software</h4>
                <p>Guarda una lista de todos los programas instalados para una reinstalaci√≥n autom√°tica.</p>
                <div class="command-box"><code
                        id="f1_dpkg">sudo bash -c "dpkg --get-selections > /root/lista_software-$FECHA.txt"</code><button
                        class="copy-btn" onclick="copyCommand('f1_dpkg')">Copiar</button></div>

                <h4>1.4. Subir los Archivos a la Nube (B2)</h4>
                <p>Sube los dos archivos versionados a tu bucket de Backblaze.</p>
                <div class="command-box"><code id="f1_rclone">sudo rclone copy /root/mi_backup_esencial-$FECHA.tar.gz B2:xtrategyq-datos/backup_fiable/ --progress
sudo rclone copy /root/lista_software-$FECHA.txt B2:xtrategyq-datos/backup_fiable/ --progress</code><button
                        class="copy-btn" onclick="copyCommand('f1_rclone')">Copiar</button></div>

                <h4>1.5. Limpieza (Recomendado)</h4>
                <p>Una vez los archivos est√©n a salvo en la nube, puedes borrarlos para liberar espacio.</p>
                <div class="command-box"><code id="f1_clean">sudo rm /root/mi_backup_esencial-$FECHA.tar.gz
sudo rm /root/lista_software-$FECHA.txt</code><button class="copy-btn"
                        onclick="copyCommand('f1_clean')">Copiar</button></div>
            </details>
        </div>

        <div class="setup-box" style="border: 2px solid #fd7e14;">
            <details>
                <summary style="color: #fd7e14;">PASO 7: Restauraci√≥n del Servidor (Fase 2)</summary>
                <div class="explanation" style="border-left-color: #fd7e14;">
                    <p>Estos son los pasos para reconstruir tu entorno por completo en un <strong>servidor nuevo y
                            vac√≠o</strong>. Sigue esta gu√≠a paso a paso para garantizar el √©xito.</p>
                </div>

                <h4>2.0. Par√°metros de Restauraci√≥n</h4>
                <p>Introduce los datos del nuevo servidor y del backup a restaurar. Se guardar√°n en la cach√© de tu
                    navegador para rellenar los comandos autom√°ticamente.</p>
                <label for="restoreDate">Fecha del Backup a Restaurar (YYYY-MM-DD):</label>
                <input type="text" id="restoreDate" oninput="updateRestoreCommands()">

                <label for="serverIp">IP del Nuevo Servidor:</label>
                <input type="text" id="serverIp" placeholder="Ej: 192.168.1.100" oninput="updateRestoreCommands()">

                <label for="publicKey">Tu Clave P√∫blica SSH (de tu Mac/PC):</label>
                <input type="text" id="publicKey" placeholder="Pega aqu√≠ el contenido de tu id_rsa.pub"
                    oninput="updateRestoreCommands()">

                <label for="serverModel">Modelo de Servidor Recomendado:</label>
                <input type="text" id="serverModel" placeholder="Ej: AMD Ryzen 9 5950X" value="AMD Ryzen 9 5950X"
                    oninput="updateRestoreCommands()">
                <button class="action-btn save" id="saveRestoreBtn">üíæ Guardar Par√°metros de Restauraci√≥n</button>
                <hr style="margin-top: 30px;">

                <h4>2.1. Contrataci√≥n y Acceso Inicial</h4>
                <ol>
                    <li><strong>Contrata un Servidor Cloud:</strong> Recomendado: <strong class="placeholder-model">AMD
                            Ryzen 9 5950X</strong>, **240 GB de disco** (ej. CPX41) con
                        **Ubuntu 22.04 LTS**.</li>
                    <li><strong>Con√©ctate como `root`</strong> usando la IP y contrase√±a del proveedor:
                        <div class="command-box"><code id="f2_ssh_root"># (En tu Mac) Borra la clave antigua del host para esta IP, si existiera
ssh-keygen -R <span class="placeholder-ip">IP_DEL_NUEVO_SERVIDOR</span>

# Conecta al servidor
ssh root@<span class="placeholder-ip">IP_DEL_NUEVO_SERVIDOR</span></code><button class="copy-btn"
                                onclick="copyCommand('f2_ssh_root')">Copiar</button></div>
                    </li>
                    <li><strong>Instalar:</strong> Ejecuta <code>installimage</code>.
                        <p class="danger"><strong>‚ö†Ô∏è CR√çTICO:</strong> Elige
                            <strong>Ubuntu-2204-jammy-amd64-base</strong>.
                        </p>
                        <p>F10 -> Yes.</p>
                    </li>
                    <li><strong>Reiniciar:</strong> Cuando acabe, escribe <code>reboot</code>.
                        <p><em>(Aqu√≠ esperamos 2 minutos a que arranque el Ubuntu nuevo).</em></p>
                    </li>
                    <li><strong>Reconectar:</strong> Al cambiar de sistema (Rescue -> Ubuntu), la huella del servidor
                        cambia.
                        <div class="command-box"><code id="f2_ssh_reconnect"># (En tu Mac) Limpia la clave antigua y reconecta
ssh-keygen -R <span class="placeholder-ip">IP_DEL_NUEVO_SERVIDOR</span>
ssh root@<span class="placeholder-ip">IP_DEL_NUEVO_SERVIDOR</span></code><button class="copy-btn"
                                onclick="copyCommand('f2_ssh_reconnect')">Copiar</button></div>
                    </li>
                </ol>

                <h4>2.2. Preparaci√≥n del Entorno (Usuario y Software)</h4>
                <p>Es vital instalar el entorno gr√°fico <strong>ANTES</strong> de restaurar los datos para evitar
                    conflictos.</p>
                <div class="command-box"><code id="f2_prep_env"># 1. Crear usuario y a√±adirlo a sudo
adduser ivan
usermod -aG sudo ivan
echo "ivan ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/ivan

# 2. Instalar TODAS las herramientas necesarias (incluido escritorio)
apt-get update && apt-get install -y sudo rclone kubuntu-desktop xrdp</code><button class="copy-btn"
                        onclick="copyCommand('f2_prep_env')">Copiar</button></div>

                <h4>2.3. Configuraci√≥n de Rclone y SSH</h4>
                <p>Ejecuta <code>rclone config</code> y configura tus claves de Backblaze B2.</p>
                <div class="command-box"><code id="f2_rclone_config_v2">rclone config</code><button class="copy-btn"
                        onclick="copyCommand('f2_rclone_config_v2')">Copiar</button></div>

                <div class="explanation">
                    <p><strong>Credenciales B2:</strong>
                    <ul>
                        <li><b>account (keyID):</b> <code id="b2_keyid_helper"></code></li>
                        <li><b>key (applicationKey):</b> <code id="b2_appkey_helper"></code></li>
                    </ul>
                    </p>
                </div>

                <p>Instala tu clave SSH p√∫blica (opcional pero recomendado):</p>
                <p>En tu Mac: <code>cat ~/.ssh/id_rsa.pub</code></p>
                <p>En el servidor:</p>
                <div class="command-box"><code id="f2_ssh_key_install">mkdir -p /home/ivan/.ssh
nano /home/ivan/.ssh/authorized_keys # (Pega tu clave aqu√≠)
chown -R ivan:ivan /home/ivan/.ssh
chmod 700 /home/ivan/.ssh && chmod 600 /home/ivan/.ssh/authorized_keys</code><button class="copy-btn"
                        onclick="copyCommand('f2_ssh_key_install')">Copiar</button></div>

                <p style="margin-top: 10px;"><strong>Ayuda:</strong> Si necesitas copiar tu clave p√∫blica al
                    portapapeles:</p>
                <button class="action-btn copy" onclick="copyPublicKey()" style="width: 100%; margin-bottom: 15px;">üìã
                    Copiar Clave P√∫blica al Portapapeles</button>

                <h4>2.4. Restauraci√≥n Quir√∫rgica (Solo Datos)</h4>
                <p>En lugar de machacar el sistema, descargamos el backup a una zona temporal y extraemos
                    <strong>SOLO</strong>
                    lo necesario.
                </p>

                <div class="command-box"><code id="f2_surgical_restore_v2"># 1. Crear directorio temporal y descargar backup
FECHA_A_RESTAURAR="<span class="placeholder-date">YYYY-MM-DD</span>"
mkdir -p /home/ivan/temp_restore
rclone copy B2:xtrategyq-datos/backup_fiable/mi_backup_esencial-${FECHA_A_RESTAURAR}.tar.gz /home/ivan/temp_restore/ --progress

# 2. Extraer SOLO lo necesario (Usando --wildcards para asegurar que encuentra los servicios)
# Extraer Home
tar -xvpzf /home/ivan/temp_restore/mi_backup_esencial-${FECHA_A_RESTAURAR}.tar.gz -C /home/ivan/temp_restore/ home/ivan
# Extraer Servicios y Firewall
tar -xvpzf /home/ivan/temp_restore/mi_backup_esencial-${FECHA_A_RESTAURAR}.tar.gz -C /home/ivan/temp_restore/ --wildcards "etc/systemd/system/sqx*" "etc/ufw/*"

# 3. Colocar las piezas en su sitio
# Datos de usuario
cp -a /home/ivan/temp_restore/home/ivan/. /home/ivan/
chown -R ivan:ivan /home/ivan

# Servicios y Firewall
sudo cp -r /home/ivan/temp_restore/etc/ufw/* /etc/ufw/
sudo cp /home/ivan/temp_restore/etc/systemd/system/sqx* /etc/systemd/system/</code><button class="copy-btn"
                        onclick="copyCommand('f2_surgical_restore_v2')">Copiar</button></div>

                <h4>2.5. Activaci√≥n Final y Limpieza</h4>
                <div class="command-box"><code id="f2_final_activation"># 1. Encender los motores de SQX (Licencia y Red) con AUTO-CORRECCI√ìN
# Detectar interfaz real y corregir el servicio
CURRENT_IFACE=$(ip route | grep default | awk '{print $5}' | head -n1)
sudo sed -i "s/dev [a-z0-9]*/dev $CURRENT_IFACE/g" /etc/systemd/system/sqx-network-setup.service

# Recargar y reiniciar TODO el circuito de licencia
systemctl daemon-reload
systemctl enable sqx-network-setup.service
systemctl enable sqx-port-proxy.service
systemctl restart sqx-network-setup.service
systemctl restart sqx-port-proxy.service

# 2. Configurar arranque de sesi√≥n gr√°fica BLINDADO
# Paramos XRDP para configurar
systemctl stop xrdp

# Aseguramos paquetes
apt-get install -y kubuntu-desktop xorgxrdp

# Borrar configs viejas que causan pantalla negra
rm -f /home/ivan/.Xauthority /home/ivan/.xsession-errors

# Crear script de arranque compatible
echo "unset DBUS_SESSION_BUS_ADDRESS" > /home/ivan/.xsession
echo "unset XDG_RUNTIME_DIR" >> /home/ivan/.xsession
echo "startplasma-x11" >> /home/ivan/.xsession

# Asegurar permisos correctos (CR√çTICO)
chown ivan:ivan /home/ivan/.xsession
chown -R ivan:ivan /home/ivan/.ssh
chown ivan:ivan /home/ivan/.Xauthority 2>/dev/null

# 3. Configurar Firewall y reiniciar escritorio remoto
ufw allow ssh
ufw allow 3389/tcp
ufw --force enable
systemctl start xrdp

# 4. Limpieza final
rm -rf /home/ivan/temp_restore</code><button class="copy-btn"
                        onclick="copyCommand('f2_final_activation')">Copiar</button></div>

                <h4>2.6. Verificaci√≥n Final</h4>
                <p>Ya puedes abrir <strong>Microsoft Remote Desktop</strong>, conectar a la IP con el usuario
                    <code>ivan</code>
                    y verificar que tu StrategyQuant funciona correctamente.
                </p>

                <h4>2.7. Preparaci√≥n Final de StrategyQuant X (Linux)</h4>
                <p>Una vez dentro, descargamos la APLICACI√ìN (no los datos de s√≠mbolos, que ya est√°n en el backup).
                </p>
                <div class="command-box"><code id="f2_sqx_app_download"># Descargar la APP SQX (versi√≥n Linux con symlinks)
rclone sync "B2:xtrategyq-datos/trading/apps/sqx/linux" "$HOME/Desktop/SQX_142_linux" --copy-links --progress

# Aplicar Permisos de "Sandbox" (Necesario para que arranque)
sudo chown root:root "$HOME/Desktop/SQX_142_linux/internal/electron/chrome-sandbox"
sudo chmod 4755 "$HOME/Desktop/SQX_142_linux/internal/electron/chrome-sandbox"</code><button class="copy-btn"
                        onclick="copyCommand('f2_sqx_app_download')">Copiar</button></div>
                <p>Con esto queda niquelado. Ahora s√≠, ejecuta ese √∫ltimo paso de descargar la App y a disfrutar del
                    servidor. üöÄ</p>




            </details>
        </div>
        <div class="setup-box" id="symlinkSection" style="border: 2px dashed #0dcaf0;">
            <details>
                <summary style="color: #0dcaf0;">PASO 8 (Opcional): Recrear Accesos Directos</summary>
                <div class="explanation" style="border-left-color: #0dcaf0;">
                    <p><strong>Cu√°ndo usar esto:</strong> Despu√©s de haber usado el comando <strong>BAJAR</strong> (del
                        PASO 1) para restaurar tu carpeta <code>automatizacion_escritorio</code> en una m√°quina nueva.
                    </p>
                    <p>Estos comandos crear√°n "accesos directos" en tu escritorio principal que apuntan a los lanzadores
                        reales dentro de la carpeta.</p>
                </div>

                <h4>Comandos para Kubuntu/Linux</h4>
                <label>Acceso directo para "Crear Proyecto":</label>
                <div class="command-box">
                    <code id="createSymlinkCmd1"></code>
                    <button class="copy-btn" onclick="copyCommand('createSymlinkCmd1')">Copiar</button>
                </div>

                <label>Acceso directo para "Gestionar Proyectos":</label>
                <div class="command-box">
                    <code id="createSymlinkCmd2"></code>
                    <button class="copy-btn" onclick="copyCommand('createSymlinkCmd2')">Copiar</button>
                </div>
            </details>
        </div>

    </div>

    <!-- Scripts de Google para Drive API -->
    <script>
        // Callbacks globales para cuando se cargan los scripts de Google
        function gapiLoaded() {
            console.log('[LOG] Google API script cargado');
            if (window.initializeGapiClient) window.initializeGapiClient();
        }
        function gisLoaded() {
            console.log('[LOG] Google Identity Services script cargado');
            if (window.initializeGisClient) window.initializeGisClient();
        }
    </script>


    <script>
        // 1. Integraci√≥n de Google Drive
        const CLIENT_ID = '901266295637-bskq2430d509c2ojhkrnko6j24qtoviu.apps.googleusercontent.com'; // Credencial del proyecto cuaderno-profesor
        const API_KEY = 'YOUR_API_KEY'; // No se usa API_KEY en cuaderno-profesor, solo OAuth2
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        // Elementos de UI para Auth
        const authButton = document.getElementById('authBtn');
        const signoutButton = document.getElementById('signoutBtn');
        const authStatus = document.getElementById('authStatus');

        // Inicializaci√≥n de Google API
        window.initializeGapiClient = async function () {
            if (window.location.protocol === 'file:') {
                console.warn('Google API no se inicializa en protocolo file://. Usa localhost.');
                return;
            }
            if (typeof gapi === 'undefined') {
                console.log("GAPI no est√° cargado a√∫n. Esperando...");
                return;
            }
            try {
                console.log('[LOG] Inicializando cliente GAPI...');
                // Cargar m√≥dulos client y picker
                await new Promise((resolve, reject) => {
                    gapi.load('client:picker', { callback: resolve, onerror: reject });
                });
                console.log('[LOG] M√≥dulos client y picker cargados');

                // Inicializar cliente (sin API Key, solo OAuth)
                await gapi.client.init({
                    discoveryDocs: [DISCOVERY_DOC],
                });
                console.log('[LOG] Cliente GAPI inicializado correctamente');
                gapiInited = true;
                maybeEnableButtons();
            } catch (error) {
                console.error("Error al inicializar Google API:", error);
            }
        }

        // --- FUNCIONES DE GOOGLE PICKER (Replicado de cuaderno-profesor) ---

        function createPicker(accessToken) {
            console.log('[LOG] Creando el Picker de Google...');
            const view = new google.picker.View(google.picker.ViewId.DOCS);
            // Filtramos para que solo se puedan seleccionar archivos JSON
            view.setMimeTypes("application/json,text/plain");

            const picker = new google.picker.PickerBuilder()
                .setAppId(CLIENT_ID.split('-')[0]) // El App ID es la primera parte del Client ID
                .setOAuthToken(accessToken)
                .addView(view)
                .setCallback((data) => pickerCallback(data, accessToken))
                .build();
            picker.setVisible(true);
        }

        async function pickerCallback(data, accessToken) {
            if (data[google.picker.Response.ACTION] == google.picker.Action.PICKED) {
                const doc = data[google.picker.Response.DOCUMENTS][0];
                const fileId = doc[google.picker.Document.ID];
                const fileName = doc[google.picker.Document.NAME];
                console.log(`[LOG] Archivo seleccionado: ${fileName} (${fileId})`);

                await fetchFileContent(fileId, fileName, accessToken);
            }
        }

        async function fetchFileContent(fileId, fileName, accessToken) {
            const driveStatus = document.getElementById('driveStatus');
            driveStatus.textContent = 'Descargando...';

            console.log(`[LOG] Descargando contenido del archivo con ID: ${fileId}`);
            try {
                const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`Error al descargar el archivo: ${response.statusText}`);
                }

                const config = await response.json();
                console.log('[LOG] Contenido del JSON descargado:', config);
                currentDriveFileId = fileId; // Guardar ID para futuras actualizaciones

                // Aplicar configuraci√≥n
                loadConfigFromObject(config);

                driveStatus.textContent = '‚úÖ Cargado';
                driveStatus.style.color = '#28a745';
                alert(`‚úÖ Configuraci√≥n cargada correctamente desde '${fileName}'!`);

            } catch (err) {
                console.error("Error al procesar el archivo JSON:", err);
                driveStatus.textContent = '‚ùå Error';
                driveStatus.style.color = '#dc3545';
                alert(`Hubo un problema al leer el archivo: ${err.message}`);
            }
        }

        function loadConfigFromObject(config) {
            if (config.tasks) {
                syncTasks = config.tasks;
                populateSyncSelector();
            }
            if (config.keyID) document.getElementById('keyID').value = config.keyID;
            if (config.applicationKey) document.getElementById('applicationKey').value = config.applicationKey;
            if (config.selectedOS) document.getElementById('osSelector').value = config.selectedOS;
            if (config.restoreDate) document.getElementById('restoreDate').value = config.restoreDate;
            if (config.serverIp) document.getElementById('serverIp').value = config.serverIp;
            if (config.publicKey) document.getElementById('publicKey').value = config.publicKey;
            if (config.serverModel) document.getElementById('serverModel').value = config.serverModel;

            updateAll();
        }

        window.initializeGisClient = function () {
            if (window.location.protocol === 'file:') {
                console.warn('Google Identity Services no se inicializa en protocolo file://. Usa localhost.');
                return;
            }
            if (typeof google === 'undefined' || !google.accounts) {
                console.log("Google Identity Services no est√° cargado a√∫n. Esperando...");
                return;
            }
            try {
                console.log('[LOG] Inicializando Google Identity Services...');
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: '', // defined later
                });
                console.log('[LOG] Google Identity Services inicializado correctamente');
                gisInited = true;
                maybeEnableButtons();
            } catch (error) {
                console.error("Error al inicializar Google Identity Services:", error);
            }
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                // Las APIs est√°n listas pero a√∫n no mostramos el bot√≥n de autenticaci√≥n
                // porque usamos el bot√≥n "Cargar desde Drive" directamente
                console.log('[LOG] APIs de Google listas para usar');
            }
        }

        function handleAuthClick() {
            return new Promise((resolve, reject) => {
                tokenClient.callback = async (resp) => {
                    if (resp.error !== undefined) {
                        reject(resp);
                        return;
                    }
                    console.log('[LOG] Autenticaci√≥n exitosa, token obtenido');
                    resolve(resp);
                };

                if (gapi.client.getToken() === null) {
                    // Solicitar token por primera vez
                    tokenClient.requestAccessToken({ prompt: 'consent' });
                } else {
                    // Ya hay un token, solo refrescarlo
                    tokenClient.requestAccessToken({ prompt: '' });
                }
            });
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                console.log('[LOG] Sesi√≥n cerrada');
            }
        }

        // Estado local de la aplicaci√≥n
        let syncTasks = {};
        let currentDriveFileId = null;
        const baseRemotePath = "B2:xtrategyq-datos/trading";
        const sqxInternalCachePath = "SQX_Hibrido_141_lib142/internal/electron/resources/userData/SQUANT";
        const CONFIG_FILENAME = 'panel_control_config.json';

        const defaultTasks = {
            "sqx_data_config": {
                name: "Configuraci√≥n SQX", group: "üìä TRADING DATA", remote: `${baseRemotePath}/data`,
                local_windows: "%USERPROFILE%\\Desktop\\TradingData\\SQX_Config", local_kubuntu:
                    "$HOME/Desktop/TradingData/SQX_Config"
            },
            "sqx_app_win": {
                name: "App - StrategyQuant X (Windows)", group: "‚öôÔ∏è APLICACIONES", remote:
                    `${baseRemotePath}/apps/sqx/windows`, local_windows: "%USERPROFILE%\\Desktop\\TradingApps\\SQX_Windows",
                local_kubuntu: "$HOME/Desktop/TradingApps/SQX_Windows"
            },
            "sqx_app_linux": {
                name: "App - StrategyQuant X (Linux)", group: "‚öôÔ∏è APLICACIONES", remote:
                    `${baseRemotePath}/apps/sqx/linux`, local_windows: "%USERPROFILE%\\Desktop\\TradingApps\\SQX_Linux",
                local_kubuntu: "$HOME/Desktop/TradingApps/SQX_Linux"
            },
            "mt5_app_win": {
                name: "App - MetaTrader 5 (Windows)", group: "‚öôÔ∏è APLICACIONES", remote:
                    `${baseRemotePath}/apps/mt5/windows`, local_windows: "%USERPROFILE%\\Desktop\\TradingApps\\MT5_Windows",
                local_kubuntu: "$HOME/Desktop/TradingApps\\MT5_Windows"
            },
            "mt5_app_linux": {
                name: "App - MetaTrader 5 (Linux)", group: "‚öôÔ∏è APLICACIONES", remote:
                    `${baseRemotePath}/apps/mt5/linux`, local_windows: "%USERPROFILE%\\Desktop\\TradingApps\\MT5_Linux",
                local_kubuntu: "$HOME/Desktop/TradingApps/MT5_Linux"
            }
        };



        // Funci√≥n para descargar la configuraci√≥n actual como JSON
        function downloadConfigAsJSON() {
            const dataToSave = {
                tasks: syncTasks,
                keyID: document.getElementById('keyID').value,
                applicationKey: document.getElementById('applicationKey').value,
                selectedOS: document.getElementById('osSelector').value,
                selectedTask: document.getElementById('syncSelector').value,
                restoreDate: document.getElementById('restoreDate').value,
                serverIp: document.getElementById('serverIp').value,
                publicKey: document.getElementById('publicKey').value,
                serverModel: document.getElementById('serverModel').value,
            };

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(dataToSave, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "panel_control_config.json");
            document.body.appendChild(downloadAnchorNode); // required for firefox
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        // Funci√≥n para cargar configuraci√≥n desde un archivo local
        function loadConfigFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.tasks) syncTasks = data.tasks;
                    if (data.keyID) document.getElementById('keyID').value = data.keyID;
                    if (data.applicationKey) document.getElementById('applicationKey').value = data.applicationKey;
                    if (data.selectedOS) document.getElementById('osSelector').value = data.selectedOS;

                    // Intentar establecer la tarea seleccionada si existe
                    if (data.selectedTask) {
                        // Necesitamos actualizar el selector primero
                        updateTaskSelector();
                        document.getElementById('syncSelector').value = data.selectedTask;
                    }

                    if (data.restoreDate) document.getElementById('restoreDate').value = data.restoreDate;
                    if (data.serverIp) document.getElementById('serverIp').value = data.serverIp;
                    if (data.publicKey) document.getElementById('publicKey').value = data.publicKey;
                    if (data.serverModel) document.getElementById('serverModel').value = data.serverModel;

                    updateAll();
                    alert("‚úÖ Configuraci√≥n cargada correctamente.");
                } catch (error) {
                    console.error("Error parsing JSON:", error);
                    alert("‚ùå Error al leer el archivo JSON. Aseg√∫rate de que es un archivo v√°lido.");
                }
                // Limpiar el input para permitir cargar el mismo archivo de nuevo si es necesario
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        // Funciones Helper para Drive
        async function findConfigFile() {
            let response;
            try {
                response = await gapi.client.drive.files.list({
                    'pageSize': 1,
                    'fields': 'files(id, name)',
                    'q': `name = '${CONFIG_FILENAME}' and trashed = false`
                });
                const files = response.result.files;
                if (files && files.length > 0) {
                    return files[0].id;
                } else {
                    return null;
                }
            } catch (err) {
                console.error("Error buscando archivo:", err);
                return null;
            }
        }

        // Nueva funci√≥n para GUARDAR datos en Drive
        async function saveDataToDrive() {
            if (!gapi.client.getToken()) {
                alert("Por favor, con√©ctate a Google Drive primero.");
                return;
            }

            const dataToSave = {
                tasks: syncTasks,
                keyID: document.getElementById('keyID').value,
                applicationKey: document.getElementById('applicationKey').value,
                selectedOS: document.getElementById('osSelector').value,
                selectedTask: document.getElementById('syncSelector').value,
                restoreDate: document.getElementById('restoreDate').value,
                serverIp: document.getElementById('serverIp').value,
                publicKey: document.getElementById('publicKey').value,
                serverModel: document.getElementById('serverModel').value,
            };

            const fileContent = JSON.stringify(dataToSave, null, 2);

            // Usar el ID actual si existe, si no, buscar por nombre
            let fileId = currentDriveFileId;
            if (!fileId) {
                fileId = await findConfigFile();
            }

            const file = new Blob([fileContent], { type: 'application/json' });
            const metadata = {
                'name': CONFIG_FILENAME,
                'mimeType': 'application/json'
            };

            const accessToken = gapi.client.getToken().access_token;
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', file);

            try {
                let url = 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart';
                let method = 'POST';

                if (fileId) {
                    url = `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart`;
                    method = 'PATCH';
                }

                const response = await fetch(url, {
                    method: method,
                    headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                    body: form
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log("Datos guardados en Drive. ID:", result.id);
                    currentDriveFileId = result.id; // Actualizar ID
                    alert("‚úÖ Datos guardados correctamente en Google Drive.");
                } else {
                    const errorBody = await response.text();
                    console.error('Error body:', errorBody);
                    throw new Error(`Error en la respuesta de Drive (${response.status}): ${response.statusText} - ${errorBody}`);
                }

            } catch (error) {
                console.error("Error al guardar en Drive: ", error);
                alert(`Error: No se pudieron guardar los datos en Drive.\n\nDetalles: ${error.message}`);
            }
        }

        // Nueva funci√≥n para CARGAR datos de Drive
        async function loadDataFromDrive() {
            try {
                const fileId = await findConfigFile();

                if (fileId) {
                    console.log("Cargando datos desde Drive...");
                    const response = await gapi.client.drive.files.get({
                        fileId: fileId,
                        alt: 'media'
                    });

                    const data = response.result; // gapi parsea el JSON autom√°ticamente si es application/json

                    // Carga de tareas con fallback
                    syncTasks = (data.tasks && Object.keys(data.tasks).length > 0) ? data.tasks : defaultTasks;

                    // Carga de preferencias y configuraciones
                    document.getElementById('keyID').value = data.keyID || '';
                    document.getElementById('applicationKey').value = data.applicationKey || '';
                    document.getElementById('osSelector').value = data.selectedOS || 'kubuntu';

                    populateSyncSelector(); // Poblar antes de seleccionar

                    const savedTask = data.selectedTask;
                    if (savedTask && syncTasks[savedTask]) {
                        document.getElementById('syncSelector').value = savedTask;
                    }

                    document.getElementById('restoreDate').value = data.restoreDate || '';
                    document.getElementById('serverIp').value = data.serverIp || '';
                    document.getElementById('publicKey').value = data.publicKey || '';
                    document.getElementById('serverModel').value = data.serverModel || 'AMD Ryzen 9 5950X';

                } else {
                    console.log("No existe el archivo de configuraci√≥n. Usando defaults.");
                    // Primera ejecuci√≥n: usar datos por defecto
                    syncTasks = defaultTasks;
                    populateSyncSelector();
                    // No guardamos autom√°ticamente para no crear basura si el usuario solo estaba mirando
                }

                updateAll(); // Actualizar la UI despu√©s de cargar/inicializar

            } catch (error) {
                console.error("Error al cargar desde Drive: ", error);
                alert("Error: No se pudieron cargar los datos. Usando configuraci√≥n por defecto.");
                // Fallback
                syncTasks = defaultTasks;
                populateSyncSelector();
                updateAll();
            }
        }

        // Nueva funci√≥n para DESCARGAR configuraci√≥n como archivo JSON
        function downloadConfigAsJSON() {
            const dataToExport = {
                tasks: syncTasks,
                keyID: document.getElementById('keyID').value,
                applicationKey: document.getElementById('applicationKey').value,
                selectedOS: document.getElementById('osSelector').value,
                selectedTask: document.getElementById('syncSelector').value,
                restoreDate: document.getElementById('restoreDate').value,
                serverIp: document.getElementById('serverIp').value,
                publicKey: document.getElementById('publicKey').value,
                serverModel: document.getElementById('serverModel').value,
            };

            const jsonContent = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([jsonContent], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const link = document.createElement('a');
            link.href = url;
            link.download = CONFIG_FILENAME;
            link.style.display = 'none';

            document.body.appendChild(link);
            link.click();

            // Limpiar
            setTimeout(() => {
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }, 100);

            console.log("Descarga iniciada para:", CONFIG_FILENAME);
            alert("‚úÖ Descarga iniciada.\n\nRevisa tu carpeta de Descargas para el archivo 'panel_control_config.json'");
        }

        // Nueva funci√≥n para COPIAR configuraci√≥n al portapapeles
        function copyConfigToClipboard() {
            const dataToExport = {
                tasks: syncTasks,
                keyID: document.getElementById('keyID').value,
                applicationKey: document.getElementById('applicationKey').value,
                selectedOS: document.getElementById('osSelector').value,
                selectedTask: document.getElementById('syncSelector').value,
                restoreDate: document.getElementById('restoreDate').value,
                serverIp: document.getElementById('serverIp').value,
                publicKey: document.getElementById('publicKey').value,
                serverModel: document.getElementById('serverModel').value,
            };

            const jsonContent = JSON.stringify(dataToExport, null, 2);

            navigator.clipboard.writeText(jsonContent).then(() => {
                alert("‚úÖ JSON copiado al portapapeles!\n\nAhora:\n1. Abre un editor de texto\n2. Pega el contenido (Cmd+V)\n3. Guarda como 'panel_control_config.json'");
            }).catch((error) => {
                console.error("Error al copiar al portapapeles:", error);
                // Fallback: mostrar el JSON en consola
                console.log("=== CONFIGURACI√ìN JSON ===");
                console.log(jsonContent);
                alert("‚ö†Ô∏è No se pudo copiar autom√°ticamente.\n\nEl JSON se ha mostrado en la consola del navegador (presiona F12 para verlo).");
            });
        }

        // Nueva funci√≥n para CARGAR configuraci√≥n desde archivo JSON
        function loadConfigFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);

                    // Carga de tareas con fallback
                    syncTasks = (data.tasks && Object.keys(data.tasks).length > 0) ? data.tasks : defaultTasks;

                    // Carga de preferencias y configuraciones
                    document.getElementById('keyID').value = data.keyID || '';
                    document.getElementById('applicationKey').value = data.applicationKey || '';
                    document.getElementById('osSelector').value = data.selectedOS || 'kubuntu';

                    populateSyncSelector(); // Poblar antes de seleccionar

                    const savedTask = data.selectedTask;
                    if (savedTask && syncTasks[savedTask]) {
                        document.getElementById('syncSelector').value = savedTask;
                    }

                    document.getElementById('restoreDate').value = data.restoreDate || '';
                    document.getElementById('serverIp').value = data.serverIp || '';
                    document.getElementById('publicKey').value = data.publicKey || '';
                    document.getElementById('serverModel').value = data.serverModel || 'AMD Ryzen 9 5950X';

                    updateAll(); // Actualizar la UI despu√©s de cargar

                    console.log("Configuraci√≥n cargada desde archivo JSON.");
                    alert("‚úÖ Configuraci√≥n cargada correctamente desde archivo.");

                } catch (error) {
                    console.error("Error al parsear el archivo JSON: ", error);
                    alert("‚ùå Error: El archivo seleccionado no es un JSON v√°lido.");
                }
            };
            reader.readAsText(file);

            // Limpiar el input para permitir recargar el mismo archivo si es necesario
            event.target.value = '';
        }

        // Nueva funci√≥n para CONECTAR y CARGAR desde Google Drive
        async function connectAndLoadFromDrive() {
            const driveStatus = document.getElementById('driveStatus');

            // Verificaci√≥n de protocolo
            if (window.location.protocol === 'file:') {
                alert("‚ö†Ô∏è ERROR: Google Drive API no funciona si abres el archivo directamente (file://).\n\nPor favor, usa un servidor local (http://localhost:8000).\n\nPuedes iniciarlo con: python3 -m http.server 8000");
                return;
            }

            try {
                // Verificar si gapi est√° disponible
                if (typeof gapi === 'undefined' || !gapi.client) {
                    throw new Error('Google Drive API no est√° disponible. Aseg√∫rate de configurar las credenciales.');
                }

                driveStatus.textContent = 'Conectando...';
                driveStatus.style.color = '#ffc107';

                // Iniciar autenticaci√≥n
                console.log('[LOG] Solicitando autenticaci√≥n...');
                const tokenResponse = await handleAuthClick();

                // Listar archivos JSON
                driveStatus.textContent = 'Listando archivos...';
                console.log('[LOG] Buscando archivos JSON en Drive...');

                const response = await gapi.client.drive.files.list({
                    q: "mimeType='application/json' and trashed=false",
                    spaces: 'drive',
                    fields: 'files(id, name, modifiedTime)',
                    orderBy: 'modifiedTime desc',
                    pageSize: 20 // Mostrar los √∫ltimos 20
                });

                const files = response.result.files;
                if (!files || files.length === 0) {
                    driveStatus.textContent = '‚ùå Sin archivos';
                    driveStatus.style.color = '#dc3545';
                    alert("No se encontraron archivos JSON en tu Google Drive.");
                    return;
                }

                // Mostrar modal de selecci√≥n
                driveStatus.textContent = 'Seleccionando...';
                const selectedFile = await showFileSelectionModal(files);

                if (!selectedFile) {
                    driveStatus.textContent = 'Cancelado';
                    driveStatus.style.color = '#6c757d';
                    return;
                }

                // Descargar el archivo seleccionado
                console.log(`[LOG] Archivo seleccionado: ${selectedFile.name} (${selectedFile.id})`);
                await fetchFileContent(selectedFile.id, selectedFile.name, tokenResponse.access_token);

            } catch (error) {
                console.error("Error al cargar desde Drive:", error);
                driveStatus.textContent = '‚ùå Error';
                driveStatus.style.color = '#dc3545';
                alert(`‚ùå Error al conectar con Google Drive:\n\n${error.message || error.error}`);
            }
        }

        function showFileSelectionModal(files) {
            return new Promise((resolve) => {
                // Crear modal din√°micamente
                const modalOverlay = document.createElement('div');
                modalOverlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;justify-content:center;align-items:center;z-index:9999;';

                const modalContent = document.createElement('div');
                modalContent.style.cssText = 'background:white;padding:20px;border-radius:8px;width:90%;max-width:500px;max-height:80vh;overflow-y:auto;box-shadow:0 4px 6px rgba(0,0,0,0.1);';

                // T√≠tulo
                const title = document.createElement('h3');
                title.textContent = 'üìÇ Selecciona un archivo de Drive';
                title.style.cssText = 'margin-top:0;margin-bottom:15px;color:#333;border-bottom:1px solid #eee;padding-bottom:10px;';
                modalContent.appendChild(title);

                // Lista de archivos
                const list = document.createElement('div');
                list.style.cssText = 'display:flex;flex-direction:column;gap:8px;';

                files.forEach(file => {
                    const btn = document.createElement('button');
                    const date = new Date(file.modifiedTime).toLocaleDateString();
                    btn.innerHTML = `<strong>${file.name}</strong> <span style="font-size:0.8em;color:#666;">(${date})</span>`;
                    btn.style.cssText = 'padding:10px;text-align:left;border:1px solid #ddd;border-radius:4px;background:#f8f9fa;cursor:pointer;transition:background 0.2s;';
                    btn.onmouseover = () => btn.style.background = '#e9ecef';
                    btn.onmouseout = () => btn.style.background = '#f8f9fa';

                    btn.onclick = () => {
                        document.body.removeChild(modalOverlay);
                        resolve(file);
                    };
                    list.appendChild(btn);
                });
                modalContent.appendChild(list);

                // Bot√≥n Cancelar
                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = 'Cancelar';
                cancelBtn.style.cssText = 'margin-top:15px;width:100%;padding:10px;background:#6c757d;color:white;border:none;border-radius:4px;cursor:pointer;';
                cancelBtn.onclick = () => {
                    document.body.removeChild(modalOverlay);
                    resolve(null);
                };
                modalContent.appendChild(cancelBtn);

                modalOverlay.appendChild(modalContent);
                document.body.appendChild(modalOverlay);
            });
        }

        // El resto del c√≥digo de la UI permanece mayormente igual
        window.updateAll = updateAll;
        window.updateCommands = updateCommands;
        window.updateMoveCommand = updateMoveCommand;
        window.updateRestoreCommands = updateRestoreCommands;
        window.copyCommand = copyCommand;
        window.copyB2CredsForWizard = copyB2CredsForWizard;
        window.copyDangerousCommand = copyDangerousCommand;
        window.executeMove = executeMove;
        window.handleAuthClick = handleAuthClick;
        window.handleSignoutClick = handleSignoutClick;
        window.downloadConfigAsJSON = downloadConfigAsJSON;
        window.copyConfigToClipboard = copyConfigToClipboard;
        window.loadConfigFromFile = loadConfigFromFile;
        window.connectAndLoadFromDrive = connectAndLoadFromDrive;


        function populateSyncSelector() {
            const mainSelector = document.getElementById('syncSelector');
            const moveSelector = document.getElementById('moveSourceTask');
            const previouslySelectedTask = mainSelector.value;
            mainSelector.innerHTML = '';
            if (moveSelector) moveSelector.innerHTML = '';
            const groups = {};
            const moveGroups = {};
            for (const key in syncTasks) {
                const task = syncTasks[key];
                const groupName = task.group || 'Tareas Personalizadas';
                if (!groups[groupName]) {
                    groups[groupName] = document.createElement('optgroup');
                    groups[groupName].label = groupName;
                    mainSelector.appendChild(groups[groupName]);
                    if (moveSelector) {
                        moveGroups[groupName] = document.createElement('optgroup');
                        moveGroups[groupName].label = groupName;
                        moveSelector.appendChild(moveGroups[groupName]);
                    }
                }
                const option = document.createElement('option');
                option.value = key;
                option.innerText = task.name;
                groups[groupName].appendChild(option);
                if (moveSelector) {
                    const moveOption = option.cloneNode(true);
                    moveGroups[groupName].appendChild(moveOption);
                }
            }
            if (previouslySelectedTask && syncTasks[previouslySelectedTask]) {
                mainSelector.value = previouslySelectedTask;
            } else {
                const firstTaskKey = Object.keys(syncTasks)[0];
                mainSelector.value = firstTaskKey || '';
            }
            if (moveSelector) {
                moveSelector.value = mainSelector.value;
            }
        }

        function getOSConfig() {
            const os = document.getElementById('osSelector').value;
            return {
                name: os, executable: os === 'windows' ? "C:\\rclone\\rclone.exe" : "rclone", pathSeparator: os ===
                    'windows' ? "\\" : "/"
            };
        }

        function updateAll() {
            const osConfig = getOSConfig();
            const selectedTaskKey = document.getElementById('syncSelector').value;
            const isWindows = osConfig.name === 'windows';
            const newColor = isWindows ? 'var(--theme-color-windows)' : 'var(--theme-color-kubuntu)';
            document.documentElement.style.setProperty('--current-theme-color', newColor);
            document.getElementById('main-title').innerText = isWindows ? 'üöÄ Panel (Windows)' : 'üöÄ Panel (Linux)';
            document.getElementById('installWindows').style.display = isWindows ? 'block' : 'none';
            document.getElementById('installKubuntu').style.display = isWindows ? 'none' : 'block';
            document.getElementById('cacheCommandsWindows').style.display = isWindows ? 'block' : 'none';
            document.getElementById('cacheCommandsKubuntu').style.display = isWindows ? 'none' : 'block';

            const symlinkSection = document.getElementById('symlinkSection');
            if (symlinkSection) {
                symlinkSection.style.display = isWindows ? 'none' : 'block';
            }

            if (!selectedTaskKey || !syncTasks[selectedTaskKey]) {
                document.getElementById('localPath').value = 'No hay tarea seleccionada.';
                document.getElementById('remotePath').value = 'No hay tarea seleccionada.';
            } else {
                const taskDetails = syncTasks[selectedTaskKey];
                const localPathKey = `local_${osConfig.name}`;
                document.getElementById('localPath').value = taskDetails[localPathKey];
                document.getElementById('remotePath').value = taskDetails.remote;
            }
            updateCommands();
            if (document.getElementById('moveSourceTask')) {
                updateMoveCommand();
            }
            updateRestoreCommands();

            // --- INICIO DE LA L√ìGICA A√ëADIDA ---
            // Rellena los comandos de la soluci√≥n de errores de SQX en Linux
            const sqxSyncFixElem = document.getElementById('f2_sqx_fix_sync');
            const sqxPermsFixElem = document.getElementById('f2_sqx_fix_perms');

            if (sqxSyncFixElem && sqxPermsFixElem) {
                let sqxRemotePath = "SELECCIONA_UNA_TAREA";
                let sqxLocalPath = "SELECCIONA_UNA_TAREA";

                if (selectedTaskKey && syncTasks[selectedTaskKey]) {
                    const currentTask = syncTasks[selectedTaskKey];
                    sqxRemotePath = currentTask.remote;
                    // Usamos la ruta de kubuntu porque estos comandos son espec√≠ficos para Linux
                    // Si la tarea no tiene ruta de kubuntu definida, usamos un placeholder
                    sqxLocalPath = currentTask.local_kubuntu || "RUTA_LOCAL_NO_DEFINIDA";
                }

                // Rellena el comando de sincronizaci√≥n
                sqxSyncFixElem.innerText = `rclone sync "${sqxRemotePath}" "${sqxLocalPath}" --copy-links --progress`;

                // Rellena los comandos de permisos
                const sandboxPath = `${sqxLocalPath}/internal/electron/chrome-sandbox`;
                sqxPermsFixElem.innerText = `# Cambiar el propietario a root
        sudo chown root:root "${sandboxPath}"

        # Cambiar los permisos
        sudo chmod 4755 "${sandboxPath}"`;
            }
            // --- FIN DE LA L√ìGICA A√ëADIDA ---
        }

        function updateCommands() {
            const osConfig = getOSConfig();
            const rcloneExecutable = osConfig.executable;
            const localPath = document.getElementById('localPath').value;
            const remotePath = document.getElementById('remotePath').value;
            const deletePath = document.getElementById('deletePath').value;
            document.getElementById('syncUpCommand').innerText = `${rcloneExecutable} sync "${localPath}" "${remotePath}" --progress --create-empty-src-dirs --b2-hard-delete --exclude "venv/**" --exclude "__pycache__/**" --exclude ".*" --exclude "*.log"`;
            document.getElementById('syncDownCommand').innerText = `${rcloneExecutable} sync "${remotePath}" "${localPath}" --progress --create-empty-src-dirs --b2-hard-delete --exclude "venv/**" --exclude "__pycache__/**" --exclude ".*" --exclude "*.log"`;
            document.getElementById('configCommand').innerText = `${rcloneExecutable} config`;
            document.getElementById('keyIdDisplay').innerText = document.getElementById('keyID').value || 'tu_keyID';
            document.getElementById('appKeyDisplay').innerText = document.getElementById('applicationKey').value ||
                'tu_applicationKey';
            document.getElementById('listRemotesCommand').innerText = `${rcloneExecutable} listremotes`;
            document.getElementById('checkCommand').innerText = `${rcloneExecutable} check "${localPath}" "${remotePath}"
        --progress`;
            document.getElementById('dryRunCommand').innerText = `${rcloneExecutable} sync "${localPath}" "${remotePath}"
        --progress --dry-run`;
            document.getElementById('sizeCommand').innerText = `${rcloneExecutable} size "${remotePath}"`;
            const fullDeletePath = deletePath ? `${remotePath}/${deletePath}` : null;
            document.getElementById('deleteSpecificCommand').innerText = fullDeletePath ? `${rcloneExecutable} delete
        "${fullDeletePath}" --progress` : 'Introduce una ruta relativa a borrar arriba.';
            document.getElementById('purgeCommand').innerText = `${rcloneExecutable} purge "${remotePath}" --progress`;
            const sqxDataPath = syncTasks['sqx_data_config'] ? syncTasks['sqx_data_config'][`local_${osConfig.name}`] : '';
            if (sqxDataPath) {
                const cacheBasePath = `${sqxDataPath}${osConfig.pathSeparator}${sqxInternalCachePath.replace(/\//g,
                    osConfig.pathSeparator)}`;
                if (osConfig.name === 'windows') {
                    document.getElementById('deleteCacheCmdWin1').innerText = `rmdir /s /q "${cacheBasePath}\\Cache"`;
                    document.getElementById('deleteCacheCmdWin2').innerText = `rmdir /s /q "${cacheBasePath}\\DawnCache"`;
                    document.getElementById('deleteCacheCmdWin3').innerText = `rmdir /s /q "${cacheBasePath}\\GPUCache"`;
                    document.getElementById('deleteCacheCmdWin4').innerText = `rmdir /s /q "${cacheBasePath}\\Code Cache"`;
                } else {
                    document.getElementById('deleteCacheCmdKubuntu1').innerText = `rm -rf "${cacheBasePath}/Cache"`;
                    document.getElementById('deleteCacheCmdKubuntu2').innerText = `rm -rf "${cacheBasePath}/DawnCache"`;
                    document.getElementById('deleteCacheCmdKubuntu3').innerText = `rm -rf "${cacheBasePath}/GPUCache"`;
                    document.getElementById('deleteCacheCmdKubuntu4').innerText = `rm -rf "${cacheBasePath}/Code Cache"`;
                }
            }

            const createSymlinkCmd1 = document.getElementById('createSymlinkCmd1');
            if (createSymlinkCmd1) {
                const desktopAutomationPath = "$HOME/Desktop/automatizacion_escritorio";
                createSymlinkCmd1.innerText = `ln -s "${desktopAutomationPath}/'Crear Proyecto.desktop'" "$HOME/Desktop/'Crear
        Proyecto.desktop'"`;
                document.getElementById('createSymlinkCmd2').innerText = `ln -s "${desktopAutomationPath}/'Gestionar
        Proyectos.desktop'" "$HOME/Desktop/'Gestionar Proyectos.desktop'"`;
            }
        }

        function updateRestoreCommands() {
            const restoreDate = document.getElementById('restoreDate').value || 'YYYY-MM-DD';
            const serverIp = document.getElementById('serverIp').value || 'IP_DEL_NUEVO_SERVIDOR';
            const publicKey = document.getElementById('publicKey').value || 'tu_clave_publica';
            const serverModel = document.getElementById('serverModel').value || 'AMD Ryzen 9 5950X';

            document.querySelectorAll('.placeholder-date').forEach(el => el.innerText = restoreDate);
            document.querySelectorAll('.placeholder-model').forEach(el => el.innerText = serverModel);
            document.querySelectorAll('.placeholder-ip').forEach(el => el.innerText = serverIp);
            document.querySelectorAll('.placeholder-key').forEach(el => el.innerText = publicKey);

            // Update B2 Helper
            const keyID = document.getElementById('keyID').value || 'tu_keyID (del PASO 3)';
            const appKey = document.getElementById('applicationKey').value || 'tu_applicationKey (del PASO 3)';
            const b2KeyIdHelper = document.getElementById('b2_keyid_helper');
            const b2AppKeyHelper = document.getElementById('b2_appkey_helper');
            if (b2KeyIdHelper) b2KeyIdHelper.innerText = keyID;
            if (b2AppKeyHelper) b2AppKeyHelper.innerText = appKey;
        }

        function updateMoveCommand() {
            const osConfig = getOSConfig();
            const rcloneExecutable = osConfig.executable;
            const sourceKey = document.getElementById('moveSourceTask').value;
            const destinationPath = document.getElementById('moveDestinationPath').value.trim();
            const direction = document.querySelector('input[name="moveDirection"]:checked').value;
            const commandPreview = document.getElementById('moveCommandPreview');
            if (!sourceKey || !destinationPath || !syncTasks[sourceKey]) {
                commandPreview.innerText = "Selecciona origen, destino y direcci√≥n para ver el comando.";
                return;
            }
            const sourceTask = syncTasks[sourceKey];
            let sourcePath, finalDestinationPath;
            if (direction === 'localToRemote') {
                sourcePath = sourceTask[`local_${osConfig.name}`];
                finalDestinationPath = destinationPath;
            } else {
                sourcePath = sourceTask.remote;
                finalDestinationPath = destinationPath;
            }
            commandPreview.innerText = `${rcloneExecutable} move "${sourcePath}" "${finalDestinationPath}" --progress`;
        }

        function executeMove() {
            const commandText = document.getElementById('moveCommandPreview').innerText;
            if (commandText.startsWith('Selecciona')) {
                alert('Por favor, configura la operaci√≥n de movimiento completamente antes de copiar el comando.');
                return;
            }
            const confirmation = confirm("¬°ACCI√ìN DESTRUCTIVA! (CORTAR Y PEGAR)\n\nVas a ejecutar un comando 'move'. Esta acci√≥n BORRA permanentemente los archivos de la carpeta de ORIGEN despu√©s de copiarlos al destino.\n\n¬øEst√°s absolutamente seguro de que quieres continuar?");
            if (confirmation) {
                navigator.clipboard.writeText(commandText).then(() => alert('¬°Comando de movimiento copiado!\nP√©galo en tu terminal para ejecutarlo.'), () => alert('Error al copiar el comando.'));
            } else {
                alert('Operaci√≥n cancelada.');
            }
        }

        function copyCommand(elementId) {
            const textToCopy = document.getElementById(elementId).innerText;
            navigator.clipboard.writeText(textToCopy).then(() => {
                alert('¬°Comando copiado!');
            }, () => {
                alert('Error al copiar el comando.');
            });
        }

        function copyPublicKey() {
            const key = document.getElementById('publicKey').value;
            if (!key) {
                alert('‚ö†Ô∏è El campo de Clave P√∫blica est√° vac√≠o. Por favor, rell√©nalo primero en el paso 1.');
                return;
            }
            navigator.clipboard.writeText(key).then(() => {
                alert('‚úÖ Clave p√∫blica copiada al portapapeles.\n\nAhora p√©gala en la terminal (dentro de nano).');
            }, () => {
                alert('‚ùå Error al copiar la clave.');
            });
        }

        function copyB2CredsForWizard() {
            const keyID = document.getElementById('keyID').value;
            const appKey = document.getElementById('applicationKey').value;

            if (!keyID || !appKey || keyID.includes('tu_keyID') || appKey.includes('tu_applicationKey')) {
                alert('‚ö†Ô∏è Faltan las credenciales de B2.\n\nPor favor, ve al PASO 3 (Configuraci√≥n) y rellena:\n- B2 Key ID\n- B2 Application Key\n\nLuego vuelve aqu√≠ para copiarlas.');
                // Scroll to step 3
                document.getElementById('step3-title').scrollIntoView({ behavior: 'smooth' });
                return;
            }

            const textToCopy = `Para 'account', usa: ${keyID} \nPara 'key', usa: ${appKey} `;
            navigator.clipboard.writeText(textToCopy).then(() => {
                alert('‚úÖ Credenciales de B2 copiadas.\n\nCuando `rclone config` te pida:\n1. "Account": Pega el Key ID\n2. "Key": Pega el Application Key');
            }, () => {
                alert('‚ùå Error al copiar las credenciales.');
            });
        }

        function copyDangerousCommand(elementId, confirmationMessage) {
            let commandText = document.getElementById(elementId).innerText;
            if (commandText.startsWith('Introduce una ruta')) {
                alert('Error: No has especificado una ruta.');
                return;
            }
            if (confirm(confirmationMessage)) {
                copyCommand(elementId);
            } else {
                alert('Operaci√≥n cancelada.');
            }
        }

        const taskForm = document.getElementById('taskForm');
        const formTitle = document.getElementById('formTitle');
        const taskKeyInput = document.getElementById('taskKey');
        const saveTaskBtn = document.getElementById('saveTaskBtn');

        function prepareFormForCreate() {
            formTitle.innerText = '‚ûï Definir Nueva Tarea';
            saveTaskBtn.innerText = 'üíæ Guardar Tarea';
            taskKeyInput.readOnly = false;
            taskForm.reset();
            taskForm.style.display = 'block';
            taskKeyInput.focus();
        }

        function prepareFormForEdit() {
            const selectedKey = document.getElementById('syncSelector').value;
            if (!selectedKey) { alert("No hay ninguna tarea seleccionada para editar."); return; }
            const task = syncTasks[selectedKey];
            formTitle.innerText = `‚úèÔ∏è Editando Tarea: ${task.name} `;
            saveTaskBtn.innerText = 'üíæ Actualizar Tarea';
            document.getElementById('taskName').value = task.name;
            taskKeyInput.value = selectedKey;
            taskKeyInput.readOnly = true;
            document.getElementById('taskGroup').value = task.group || '';
            document.getElementById('taskRemote').value = task.remote;
            document.getElementById('taskLocalWin').value = task.local_windows;
            document.getElementById('taskLocalKubuntu').value = task.local_kubuntu;
            taskForm.style.display = 'block';
        }

        function prepareFormForClone() {
            const selectedKey = document.getElementById('syncSelector').value;
            if (!selectedKey) {
                alert("Primero selecciona una tarea de la lista para usarla como base.");
                return;
            }
            const task = syncTasks[selectedKey];

            formTitle.innerText = `‚ûï Clonar Tarea(Basada en "${task.name}")`;
            saveTaskBtn.innerText = 'üíæ Guardar Tarea Clonada';

            document.getElementById('taskName').value = task.name + " (Copia)";
            document.getElementById('taskKey').value = ''; // ¬°Importante! Limpiar el ID
            taskKeyInput.readOnly = false; // ¬°Importante! Hacer el ID editable

            document.getElementById('taskGroup').value = task.group || '';
            document.getElementById('taskRemote').value = task.remote;
            document.getElementById('taskLocalWin').value = task.local_windows;
            document.getElementById('taskLocalKubuntu').value = task.local_kubuntu;

            taskForm.style.display = 'block';
            taskKeyInput.focus(); // Poner el foco en el campo del nuevo ID
        }

        document.getElementById('showNewTaskFormBtn').addEventListener('click', prepareFormForCreate);
        document.getElementById('cloneTaskBtn').addEventListener('click', prepareFormForClone);
        document.getElementById('editTaskBtn').addEventListener('click', prepareFormForEdit);
        document.getElementById('cancelTaskBtn').addEventListener('click', () => { taskForm.style.display = 'none'; });

        // 3. Actualizaci√≥n de Manejadores de Eventos
        document.getElementById('savePrefsBtn').addEventListener('click', async () => {
            await saveDataToDrive();
            alert('¬°Preferencias guardadas en la nube!');
        });

        document.getElementById('saveRestoreBtn').addEventListener('click', async () => {
            await saveDataToDrive();
            alert('¬°Par√°metros de restauraci√≥n guardados en la nube!');
        });

        saveTaskBtn.addEventListener('click', async () => {
            const isEditing = taskKeyInput.readOnly;
            const key = taskKeyInput.value.trim().replace(/\s+/g, '_').toLowerCase();
            const name = document.getElementById('taskName').value.trim();
            const group = document.getElementById('taskGroup').value.trim().toUpperCase();
            const remote = document.getElementById('taskRemote').value.trim();
            const local_windows = document.getElementById('taskLocalWin').value.trim();
            const local_kubuntu = document.getElementById('taskLocalKubuntu').value.trim();

            if (!key || !name || !remote || !local_windows || !local_kubuntu) {
                alert("Error: Todos los campos (excepto Grupo) son obligatorios."); return;
            }
            if (!isEditing && syncTasks[key]) {
                alert("Error: El ID √∫nico ya existe. Por favor, elige otro."); return;
            }

            syncTasks[key] = { name, group, remote, local_windows, local_kubuntu };
            populateSyncSelector();
            document.getElementById('syncSelector').value = key;
            updateAll();

            await saveDataToDrive();

            taskForm.style.display = 'none';
            alert(isEditing ? "¬°Tarea actualizada con √©xito!" : "¬°Tarea guardada con √©xito!");
        });

        document.getElementById('deleteTaskBtn').addEventListener('click', async () => {
            const selector = document.getElementById('syncSelector');
            if (!selector.value) {
                alert("No hay tareas para borrar.");
                return;
            }
            if (Object.keys(syncTasks).length <= 1) {
                alert("No puedes borrar la √∫ltima tarea. Ed√≠tala o a√±ade una nueva primero.");
                return;
            }
            const selectedKey = selector.value;
            const taskName = syncTasks[selectedKey].name;

            if (confirm(`¬øEst√°s seguro de que quieres borrar la tarea "${taskName}" ? `)) {
                delete syncTasks[selectedKey];
                populateSyncSelector();
                updateAll();

                await saveDataToDrive();

                alert(`Tarea "${taskName}" borrada.`);
            }
        });

        // Inicializaci√≥n: Al cargar la p√°gina, inicializamos con defaultTasks
        // Google Drive solo se usa si el usuario se autentica expl√≠citamente
        window.onload = function () {
            // Inicializar con defaultTasks inmediatamente para que la app sea usable
            syncTasks = defaultTasks;
            populateSyncSelector();
            updateAll();
            console.log("Aplicaci√≥n inicializada con configuraci√≥n predeterminada.");
            // NO llamamos a loadDataFromDrive() autom√°ticamente
            // Solo se cargar√° cuando el usuario se autentique haciendo clic en "Conectar Drive"
        };
    </script>

    <!-- Scripts de carga de Google API al final para asegurar que las funciones globales est√©n definidas -->
    <script src="https://accounts.google.com/gsi/client" async defer onload="gisLoaded()"></script>
    <script src="https://apis.google.com/js/api.js" async defer onload="gapiLoaded()"></script>
</body>

</html>